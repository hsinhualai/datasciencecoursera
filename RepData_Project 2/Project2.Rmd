This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r, echo = TRUE}
setwd("/Users/hsinhua/Desktop/Coursera/Reproducible Research/Project 2")
library(ggplot2)
library(plyr)
library(dplyr)

## import the data
data <- read.csv("repdata-data-StormData.csv")

## select out the subdata we need including Fatalities and injuries
fat_subdata <- aggregate(FATALITIES  ~ EVTYPE, data = data, sum)
fat_subdata <- fat_subdata[order(fat_subdata$FATALITIES, decreasing = T),]
fat_subdata <- fat_subdata[1:5,]
inj_subdata <- aggregate(INJURIES  ~ EVTYPE, data = data, sum)
inj_subdata <- inj_subdata[order(inj_subdata$INJURIES, decreasing =T ),]
inj_subdata <- inj_subdata[1:5,]

ggplot(fat_subdata, aes(EVTYPE, FATALITIES, fill = EVTYPE)) + geom_bar(stat = "identity", position="dodge") + ylab("Fatalities") + xlab("Event type") + ggtitle("First Five Events Types Causing the Most Fatalities")

ggplot(inj_subdata, aes(EVTYPE, INJURIES, fill = EVTYPE)) + geom_bar(stat = "identity",position="dodge") + ylab("Injuries") + xlab("Event type") + ggtitle("First Five Events Types Causing the Most Injugies")
```

Therefore, we know the answer for the first question should be "Tornado".

In order to answer the second question. We extract the event types causing the most damages to properties and crops

```{r, echo=TRUE}
## select out the subdata we need
Ecodata <- select(data, EVTYPE, PROPDMG:CROPDMGEXP)

## focus on the property damage data first
Propdata <- select(Ecodata, EVTYPE:PROPDMGEXP)

## extract out the exp data. K = 1e3, m/M = 1e6, B = 1e9. Others undefined 
## so I treat them as 1
expdata <- Propdata$PROPDMGEXP
expdata <- as.character(expdata)
good <- expdata %in% "K"
expdata[good] <- 1e3
good <- expdata %in% "M"
expdata[good] <- 1e6
good <- expdata %in% "m"
expdata[good] <- 1e6
good <- expdata %in% "B"
expdata[good] <-1e9
tmp <- c(1000,1e6, 1e9)
bad <- !expdata %in% tmp
expdata[bad] <-1
expdata <- as.numeric(expdata)

## I choose to measure everythin in million dollars
propdamage <- Propdata$PROPDMG*expdata*1e-6
Propdata <- mutate(Propdata, PropDmg = propdamage)
prop_data <- aggregate(PropDmg ~ EVTYPE, data = Propdata, sum)
prop_data <- arrange(prop_data, desc(PropDmg))

## select out the first five and make plots
prop_data <- prop_data[1:5,]
ggplot(prop_data, aes(EVTYPE, PropDmg, fill = EVTYPE)) + geom_bar(stat = "identity", position="dodge") + ylab("PropDmg (Million Dollars") + xlab("Event type") + ggtitle("Top 5 Event Types Causing the Most Property Damage")

## Now let's focus on the crop damage data
## Redo every step as above
Cropdata <- select(Ecodata, EVTYPE, CROPDMG, CROPDMGEXP)
expcrop <- Cropdata$CROPDMGEXP
expcrop <- as.character(expcrop)
good <- expcrop %in% "K"
expcrop[good] <- 1e3
good <- expcrop %in% "M"
expcrop[good] <- 1e6
good <- expcrop %in% "m"
expcrop[good] <- 1e6
good <- expdata %in% "B"
expcrop[good] <-1e9
tmp <- c(1000,1e6, 1e9)
bad <- !expcrop %in% tmp
expcrop[bad] <-1
expcrop <- as.numeric(expcrop)
cropdamage <- Cropdata$CROPDMG*expcrop*1e-6
Cropdata <- mutate(Cropdata, CropDmg = cropdamage)
crop_data <- aggregate(CropDmg ~ EVTYPE, data = Cropdata, sum)
crop_data <- arrange(crop_data, desc(CropDmg))
crop_data <- crop_data[1:5,]
ggplot(crop_data, aes(EVTYPE, CropDmg, fill = EVTYPE)) + geom_bar(stat = "identity", position="dodge") + ylab("PropDmg(Million Dollars") + xlab("Event type") + ggtitle("Top 5 Event Types Causing the Most Crop Damage")

#Let's extract the "total" damage including both property and crop damages
prop_data <- aggregate(PropDmg ~ EVTYPE, data = Propdata, sum)
crop_data <- aggregate(CropDmg ~ EVTYPE, data = Cropdata, sum)
eco_dmg <- arrange(join(prop_data, crop_data),EVTYPE)
eco_dmg <- mutate(eco_dmg, EcoDmg = PropDmg + CropDmg)
eco_dmg <- select(eco_dmg, EVTYPE, EcoDmg)
eco_dmg <- arrange(eco_dmg, desc(EcoDmg))
eco_dmg <- eco_dmg[1:5,]

## make the plot of total economic damage
ggplot(eco_dmg, aes(EVTYPE, EcoDmg, fill = EVTYPE)) + geom_bar(stat = "identity", position="dodge") + ylab("Economy_Dmg(Million Dollars") + xlab("Event type") + ggtitle("Top 5 Event Types Causing the Most Economy Damage")
```

Therefore, we know the answer for the question two should be "Flood".
